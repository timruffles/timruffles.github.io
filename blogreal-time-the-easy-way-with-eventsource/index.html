<!doctype html>
      <head>
        <title>Real-time the easy way with EventSource</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="/blogcss/normalize.css" type="text/css">
        <link rel="stylesheet" href="/blogcss/style.css" type="text/css">
        <link rel="stylesheet" href="/blogcss/prism-ghcolors.css" type="text/css">
        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-24335480-1']);
          _gaq.push(['_trackPageview']);

          function asyncScript(src) {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = src;
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          }
          asyncScript(('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js');
        </script>
      </head>
      <body class="article">
        <div id="mast">
          <div class='top-bar reading'>
              <div class="links logical">
                <div class="navigation logical">
                  <a href="/blog">Home</a>
                  <a href="https://feeds.feedburner.com/TimRufflesBlog">RSS</a>
                  <a href="/blogme">
                      Tim Ruffles
                  </a>
                </div>
              </div>
            </div>
        </div>
        <div id="content" class="reading">
           

           <div id="body">
              <h1><a href="/blogreal-time-the-easy-way-with-eventsource">Real-time the easy way with EventSource</a></h1>
  <div class="summary">
  This was originally featured on the <a href="https://web.archive.org/web/20150316213843/http://www.futureinsights.com/home/real-time-the-easy-way-with-eventsource-angularjs-and-nodejs.html">FOWA conference blog</a>, but FOWA UK was closed down ;(
</div>

<p>When people think real-time their thoughts immediately leap to web-sockets. For many use-cases there exists a more productive approach, with good browser support hitting 100% via <a href="https://github.com/Yaffle/EventSource/" >shims</a>. Meet: <a href="https://developer.mozilla.org/en-US/docs/Web/API/EventSource" >EventSource</a> AKA server-sent-events!</p>
<p>EventSource is a HTTP based protocol that allows one-way evented communication from the server to the client. It avoids the overhead of polling, provides seamless reconnection without any code on your part and has an incredibly simple API.</p>
<p>I&#39;ll take you through the server-sent events related parts of both the client and server-side of a chat application implemented via EventSource. We&#39;ll use AngularJS in the client and NodeJS in the server. The <a href="https://github.com/timruffles/chat-event-source" >full source</a> is available to read too.</p>
<h2 id="eventsource-api">EventSource API</h2>
<p>First - let&#39;s check out the EventSource API itself:</p>
<pre><code>var chatEvents <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span><span class="token string">'/rooms/'</span> <span class="token operator">+</span> id  <span class="token operator">+</span> <span class="token string">"/events"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

chatEvents<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"chat"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  var chat <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>chat<span class="token punctuation">.</span>userId <span class="token operator">!=</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    chats<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>chat<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Surprisingly cruft-free for a browser API! We provide the URL of the HTTP endpoint that&#39;ll be pushing the events, and then use the <code>addEventListener(eventName, handlerFunction)</code> API we know and love in the DOM. Just like in the DOM we have an event object holding event data in its properties. Here we want the data - which is sent as a string. I&#39;ve chosen to encode it as JSON - so we simply parse it and place it at the start of our list of chats.</p>
<h2 id="server-sent-events-protocol">Server-sent events protocol</h2>
<p>The server-side is not much more complex. The simplicity of the API is hidden in the spec, so I&#39;ll show you the full text of a session, first up the request:</p>
<pre><code>GET <span class="token operator">/</span>rooms<span class="token operator">/</span>demo<span class="token operator">/</span>events HTTP<span class="token operator">/</span><span class="token number">1.1</span>
Host<span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">1234</span></code></pre>
<p>and the response:</p>
<pre><code>HTTP<span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">200</span> OK
Content<span class="token operator">-</span>Type<span class="token punctuation">:</span> text<span class="token operator">/</span>event<span class="token operator">-</span>stream
Cache<span class="token operator">-</span>Control<span class="token punctuation">:</span> no<span class="token operator">-</span>cache
Transfer<span class="token operator">-</span>Encoding<span class="token punctuation">:</span> chunked

event<span class="token punctuation">:</span> chat
data<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"message"</span><span class="token punctuation">:</span><span class="token string">"hello world"</span><span class="token punctuation">,</span><span class="token string">"userId"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"createdAt"</span><span class="token punctuation">:</span><span class="token string">"2014-08-26T17:06:12.521Z"</span><span class="token punctuation">}</span>

event<span class="token punctuation">:</span> chat
data<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"message"</span><span class="token punctuation">:</span><span class="token string">"this is fun"</span><span class="token punctuation">,</span><span class="token string">"userId"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"createdAt"</span><span class="token punctuation">:</span><span class="token string">"2014-08-26T17:06:12.521Z"</span><span class="token punctuation">}</span></code></pre>
<p>Simplicity itself! We simply have to set the <code>Content-Type</code> to <code>text/event-stream</code>, disable caching and tell the browser to expect <code>chunked</code> encoding. Each event is sent as a number of headers (<code>event:</code>, <code>data:</code>) separated by new-lines, with a double new-line between events.</p>
<h2 id="sses-with-nodejs-and-express">SSEs with NodeJS and express</h2>
<p>Let&#39;s implement that with NodeJS. I&#39;ve chosen the <code>express</code> HTTP server library as it&#39;s simple and commonly-used. If you&#39;ve not used it before, it&#39;s just a matter of writing handler functions that use the <code>request</code> and <code>response</code> parameters (usually shortened to <code>req</code> and <code>res</code>) to respond to HTTP requests. Here&#39;s a simple one for creating a user:</p>
<pre><code>server<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/users"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  users<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>You can see we&#39;re accepting <code>POST /users</code> requests, and asynchronously responding based on the result of creating a user.</p>
<p>Implementing the real-time notifications for chat messages is simple. First we&#39;ll write an implementation of the server-side of the server-sent events spec:</p>
<pre><code><span class="token keyword">function</span> <span class="token function">startSees</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'text/event-stream'</span><span class="token punctuation">,</span>
    <span class="token string">'Cache-Control'</span><span class="token punctuation">:</span> <span class="token string">'no-cache'</span><span class="token punctuation">,</span>
    <span class="token string">'Connection'</span><span class="token punctuation">:</span> <span class="token string">'keep-alive'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">sendSse</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>data<span class="token punctuation">,</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"event: "</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"id: "</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"data: "</span> <span class="token operator">+</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>We start off by sending the server-sent event headers. After that we can keep sending new events separated by double-newlines.</p>
<p>Now we&#39;ve got our <code>sse</code> implementation, time to use it to build out the <code>/rooms/:id/events</code> endpoint:</p>
<pre><code>server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/rooms/:id/events"</span><span class="token punctuation">,</span> fetchRoom<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  var room <span class="token operator">=</span> res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>room<span class="token punctuation">;</span>
  var sse <span class="token operator">=</span> <span class="token function">startSees</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  room<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"chat"</span><span class="token punctuation">,</span> sendChat<span class="token punctuation">)</span><span class="token punctuation">;</span>

  req<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rooms<span class="token punctuation">.</span><span class="token function">removeListener</span><span class="token punctuation">(</span><span class="token string">"chat"</span><span class="token punctuation">,</span> sendChat<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">sendChat</span><span class="token punctuation">(</span>chat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sse</span><span class="token punctuation">(</span><span class="token string">"chat"</span><span class="token punctuation">,</span> chat<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>We&#39;re proxying events from a NodeJS <a href="http://nodejs.org/api/events.html" ><code>EventEmitter</code></a> through to the browser in 20 lines of code! A fully-featured implementation would only need the ability to send through the last event ID the client had received, and we&#39;d have seamless reconnection functionality.</p>
<p>Once we boot up the server we have a functional, if incredibly simple, chat application!</p>
<p><img src="https://raw.githubusercontent.com/timruffles/chat-event-source/master/article-assets/chat.png" alt="simple chat with nodejs, angularjs and server-sent events" /></p>
<p>I hope this quick run-down whetted your appetite for <code>EventSource</code>. I think it&#39;s one of those rare browser APIs that leaves you thankful to its designers for making your life easy. Please check out the <a href="https://github.com/timruffles/event-source-express-angular-real-time-tutorial" >completed example</a> and have a play!</p>

  
            </div>
        </div>
        <div class="footer reading">
          <div class="container">
            <p>ðŸ“© helloï¼ timr Â· co</p>
          </div>
        </div>
      </body>