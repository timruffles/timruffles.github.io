<!doctype html>
      <head>
        <title>Architecture for a JS to C compiler</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width">
        <meta name="description" content="
" >
        <link rel="stylesheet" href="/css/normalize.css" type="text/css">
        <link rel="stylesheet" href="/css/style.css" type="text/css">
        <link rel="stylesheet" href="/css/prism-ghcolors.css" type="text/css">
        <link rel="alternate" type="application/rss+xml" title="Subscribe to RSS feed" href="/rss.xml" />
      </head>
      <body class="article">
        <div class="mast">
          <div class='top-bar reading'>
              <div class="links logical">
                <div class="navigation logical">
                  <a href="/">Home</a>
                  <a href="/rss.xml">RSS</a>
                  <a href="/me">
                      Tim Ruffles
                  </a>
                </div>
              </div>
            </div>
        </div>
        <div class="content" class="reading">
           

           <div class="body">
              <h1><a href="/architecture-for-a-js-to-c-compiler">Architecture for a JS to C compiler</a></h1>
  <p>The basic data-flow of compilation looks like this:</p>
<ol>
<li>parse: turn the source text into something we can use as input for our compiler, usually an AST (abstract syntax tree)</li>
<li>optimisation (optional): transform the input program into an equivalent one that&#39;s more efficient in time or space</li>
<li>code generation: output a program in our target language, e.g machine code</li>
</ol>
<p>My JS to C compiler will implement this as follows</p>
<ol>
<li>parse: use <a href="http://esprima.org/" >esprima</a> - this project is about compilation not parsing</li>
<li>&amp; 3. code generation + optimisation: a compiler written in TypeScript that outputs C</li>
</ol>
<h2 id="c-as-a-target-language">C as a target language</h2>
<p>C is lower-level than JavaScript, but it still gives us a lot! We can use the following features in C to implement similar features in JavaScript:</p>
<ol>
<li>control structures: <code>if</code>, <code>for</code>, <code>while</code> etc will map well between languages</li>
<li>function calls: we can compile JS functions to C functions</li>
</ol>
<p>However, there is lots we&#39;re going to have to write from scratch. For instance C lacks data-structures beyond statically sized arrays. We&#39;ll fill this in with what&#39;s called a &#39;runtime library&#39; - a library we&#39;ll call from our compiled program. Lots of the behaviour we&#39;ll need to implement JavaScript cannot be implemented without runtime support: </p>
<ol>
<li>garbage collection</li>
<li>exception handling</li>
<li>data-structures: dynamic arrays and objects</li>
<li>prototype-based object system</li>
</ol>
<h2 id="a-sketch">A sketch</h2>
<p>Lets manually walk the following JS code through our compiler tool-chain:</p>
<pre><code><span class="token keyword">function</span> <span class="token function">fact</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> n <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token operator">?</span> n <span class="token punctuation">:</span> n <span class="token operator">*</span> <span class="token function">fact</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">fact</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>First we run esprima to parse the source and give us a syntax-tree:</p>
<pre><code><span class="token punctuation">{</span>
  <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Program"</span><span class="token punctuation">,</span>
  <span class="token string">"body"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
          <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"FunctionDeclaration"</span><span class="token punctuation">,</span>
          <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
              <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
              <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"fact"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">"params"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
              <span class="token punctuation">{</span>
                  <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
                  <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"n"</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string">"body"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
              <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"BlockStatement"</span><span class="token punctuation">,</span></code></pre>
<p>This will be input to <code>js-to-c.ts</code>, which would output a target C program. We have a ternary expression in our input program, here&#39;s a snippet from the function in the compiler that handles it. You can see we&#39;re implementing JS&#39;s ternary expression with C&#39;s <code>if</code>:</p>
<pre><code class="language-typescript"><span class="token keyword">function</span> <span class="token function">compileConditionalExpression</span><span class="token punctuation">(</span>node<span class="token operator">:</span> ConditionalExpression<span class="token punctuation">,</span> state<span class="token operator">:</span> CompileTimeState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>testSrc<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;
            JsValue* </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>resultTarget<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;
            if(isTruthy(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>testResultTarget<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)) {
                </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>consequentSrc<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
            } else {
                </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>alternateSrc<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
            }</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span></code></pre>
<p>Once our compiler has run we&#39;re left with a valid C program (hopefully). The below is the compiled <code>fact</code> function. Some interesting things to look for: the recursive call, and how the result value from the ternary is threaded through the multiplication and return:</p>
<pre><code>static JsValue <span class="token operator">*</span><span class="token function">fact_1</span><span class="token punctuation">(</span>Env <span class="token operator">*</span>env<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  JsValue <span class="token operator">*</span>return_3<span class="token punctuation">;</span>

  JsValue <span class="token operator">*</span>left_6 <span class="token operator">=</span> <span class="token function">envGet</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> interned_2 <span class="token comment">/* n */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  JsValue <span class="token operator">*</span>right_7 <span class="token operator">=</span> <span class="token function">jsValueCreateNumber</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  JsValue <span class="token operator">*</span>conditionalPredicate_5 <span class="token operator">=</span> <span class="token function">LTOperator</span><span class="token punctuation">(</span>left_6<span class="token punctuation">,</span> right_7<span class="token punctuation">)</span><span class="token punctuation">;</span>
  JsValue <span class="token operator">*</span>conditionalValue_4<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTruthy</span><span class="token punctuation">(</span>conditionalPredicate_5<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    return_3 <span class="token operator">=</span> <span class="token function">envGet</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> interned_2 <span class="token comment">/* n */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    JsValue <span class="token operator">*</span>left_8 <span class="token operator">=</span> <span class="token function">envGet</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> interned_2 <span class="token comment">/* n */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    JsValue <span class="token operator">*</span>callee_10 <span class="token operator">=</span> <span class="token function">envGet</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> interned_11 <span class="token comment">/* fact */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    JsValue <span class="token operator">*</span>left_12 <span class="token operator">=</span> <span class="token function">envGet</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> interned_2 <span class="token comment">/* n */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    JsValue <span class="token operator">*</span>right_13 <span class="token operator">=</span> <span class="token function">jsValueCreateNumber</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    JsValue <span class="token operator">*</span>call10Arg_0 <span class="token operator">=</span> <span class="token function">subtractOperator</span><span class="token punctuation">(</span>left_12<span class="token punctuation">,</span> right_13<span class="token punctuation">)</span><span class="token punctuation">;</span>
    JsValue <span class="token operator">*</span>args_10<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>call10Arg_0<span class="token punctuation">}</span><span class="token punctuation">;</span>
    JsValue <span class="token operator">*</span>right_9 <span class="token operator">=</span> <span class="token function">functionRunWithArguments</span><span class="token punctuation">(</span>callee_10<span class="token punctuation">,</span> args_10<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    return_3 <span class="token operator">=</span> <span class="token function">multiplyOperator</span><span class="token punctuation">(</span>left_8<span class="token punctuation">,</span> right_9<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> return_3<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">getUndefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>You can also see calls out to our runtime library - e.g <code>envGet()</code>. This is part of the runtime as we can&#39;t rely on the C call-stack here. In JS, functions are closures. Therefore they need the environment they close over to live well beyond the lifetime of the call-stack that defined them - think of function values stored as global properties or as event-listeners.</p>
<p>To use the runtime library our output program use C&#39;s <code>#include</code> macro to include our runtime library&#39;s header files[^2], and get access to the definitions of the functions our library has defined elsewhere:</p>
<pre><code>#include <span class="token string">"../../runtime/environments.h"</span>
#include <span class="token string">"../../runtime/exceptions.h"</span>
#include <span class="token string">"../../runtime/functions.h"</span></code></pre>
<p>[^2]: header-files in C define the function prototypes defined elsewhere in <code>.c</code> or library files. Relying on the header-files means we can target library code without recompiling.</p>
<p>In my next post, we&#39;ll look at our how our <code>js-to-c.ts</code> compiler takes a syntax tree and outputs C source code.</p>

  <div class="article-footer">
  <p class=nav>
    Next: <a href="/compiling-js-control-flow-to-c">
      Compiling JS control-flow to C
    </a>
    </p>
  <p class=nav>
    Previous: <a href="/compiling-interpreted-languages">
      Compiling Interpreted Languages
    </a>
    </p>
        <div class="comments">
        
        <p class="comment-help">
            <a href="https://github.com/timruffles/timruffles.github.io/issues/99" title="Comments handled via Github">
              Leave a comment via Github
            </a> ðŸ’¬ 
        </p>
  </div>
    </div>
            </div>
        </div>
        <div class="footer reading">
          <div class="container">
            <p>ðŸ“© helloï¼ timr Â· co</p>
          </div>
        </div>
      </body><!-- built from ab651f779079c71b32816f7f4e4ff22633082ea0 -->